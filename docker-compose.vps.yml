# Modulo: infraestrutura
# Arquivo: docker-compose.vps.yml
# Funcao no sistema: subir frontend (Nginx) + backend (Node.js) na VPS com rede do host.
# Observacao: host networking garante conectividade IPv6 do backend com Supabase quando o DNS do Postgres for apenas AAAA.

services:
  backend:
    container_name: cjm_backend
    build:
      context: ./backend
      dockerfile: Dockerfile
    image: cjm-patrimonio-backend:latest
    restart: unless-stopped
    network_mode: host
    environment:
      NODE_ENV: "production"
      HOST: "127.0.0.1"
      PORT: "3001"
      DB_SSL: "${DB_SSL:-require}"
      FRONTEND_ORIGIN: "${FRONTEND_ORIGIN:-*}"
      DATABASE_URL: "${DATABASE_URL}"
      # Modulo: backend/auth
      # Funcao: repassar AUTH_* do .env para habilitar login via JWT (quando ativado).
      AUTH_ENABLED: "${AUTH_ENABLED:-false}"
      AUTH_JWT_SECRET: "${AUTH_JWT_SECRET:-}"
      AUTH_JWT_EXPIRES_IN: "${AUTH_JWT_EXPIRES_IN:-12h}"

  frontend:
    container_name: cjm_frontend
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        VITE_API_BASE_URL: "/api"
    image: cjm-patrimonio-frontend:latest
    restart: unless-stopped
    network_mode: host
